name: Build vademecum

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Build mode"
        required: true
        default: incremental
        type: choice
        options:
          - incremental
          - full
  schedule:
    - cron: "0 3 * * 0"
    - cron: "0 4 1 * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Restore previous state from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p out
          set +e
          gh release download latest -p state.json -D out
          status=$?
          set -e
          if [ $status -ne 0 ]; then
            echo "No previous state.json found in release 'latest'."
          else
            echo "Recovered state.json from previous release."
          fi

      - name: Select mode
        id: select_mode
        run: |
          mode="incremental"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            mode="${{ github.event.inputs.mode }}"
          elif [ "${{ github.event_name }}" = "schedule" ] && [ "${{ github.event.schedule }}" = "0 4 1 * *" ]; then
            mode="full"
          fi
          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "Selected mode: $mode"

      - name: Build dataset
        env:
          OUT_DIR: ./out
          MODE: ${{ steps.select_mode.outputs.mode }}
          NOMENCLATOR_URL: ${{ secrets.NOMENCLATOR_URL }}
          HTTP_TIMEOUT: "60"
          HTTP_MAX_RETRIES: "5"
        run: |
          python -m vademecum_builder --mode "${{ steps.select_mode.outputs.mode }}"

      - name: Create or update release latest
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: latest
          files: |
            out/manifest.json
            out/state.json
            out/*.gz
          fail_on_unmatched_files: true
